
# Apache Airflow Celery Broker Remote Command Execution (CVE-2020-11981)
<br />

Apache Airflow Celery Broker Remote Command Execution (CVE-2020-11981) is an issue, that was found in Apache Airflow versions 1.10.10 . When using CeleryExecutor, if an attacker can connect to the broker (Redis, RabbitMQ) directly, it is possible to inject commands, resulting in the celery worker running arbitrary commands.
<br />
<br />


# Activating Vulnerable Environment
<br />

Run the following commands to activate vulnerable airflow 1.10.10:
<br />
<br />

#Initialize the database
<br />
docker-compose run airflow-init
<br />
<br />

#Start the docker-compose service
<br />
docker-compose up -d
<br />
<br />
# Exploitation
<br />
For this vulnerability exploitation, you have to get the write permission of the Celery broker, Redis. 
<br />
The Redis port in this environment is  6379, which is exposing on the Internet.
<br />
Therefore, make sure that Redis is installed on the VM
<br />
<br />
#Install the Redis using the command:
pip install redis
<br />
<br />
Now, you can add add the evil task airflow.executors.celery_executor.execute_command to the queue to execute arbitrary commands, by using the Redis.
<br />
<br />
Run the exploit python script 'exploit_airflow_celery.py'
<br />
python exploit_airflow_celery.py <your-ip>
<br />
<br />
This command executes the crafted payload:
<br />
touch /tmp/airflow_celery_success
<br />
<br />
If you are able to execute the exploit, you'll be able to find your next flag.
<br />
<br />
Finally, we need to check the logs using the command:
<br />
docker-compose logs airflow-worker
<br />
<br />
Now, run the bash scirpt to see the results of execution:
<br />
sudo bash test_exploit.sh
<br />
<br />
<br />
You can see your final flag with the results!!!
<br />
<br />


# References
https://nvd.nist.gov/vuln/detail/CVE-2020-11981

https://www.cvedetails.com/vulnerability-list/vendor_id-45/product_id-52213/year-2020/Apache-Airflow.html

https://vulners.com/cve/CVE-2020-11981

https://www.cybersecurity-help.cz/vdb/SB2020072006

https://www.fortiguard.com/psirt/FG-IR-22-008
